<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WhatsApp Device Manager</title>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            whatsapp: '#25D366',
            'whatsapp-dark': '#128C7E',
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gradient-to-br from-emerald-500 to-teal-600 min-h-screen flex items-center justify-center p-4">

  <div x-data="deviceManager()" x-init="init()" class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
    <!-- Header -->
    <div class="bg-whatsapp px-6 py-5 text-white">
      <h1 class="text-xl font-semibold">WhatsApp Device Manager</h1>
      <p class="text-white/80 text-sm">Manage your WhatsApp connection</p>
    </div>

    <div class="p-6 space-y-5">
      <!-- API Key Input -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1.5">API Key</label>
        <input 
          type="password" 
          x-model="apiKey"
          @change="saveApiKey()"
          placeholder="Enter your API key"
          class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg text-sm focus:outline-none focus:border-whatsapp transition-colors"
        >
      </div>

      <!-- Message Alert -->
      <div 
        x-show="message.text" 
        x-transition
        :class="message.type === 'error' ? 'bg-red-50 text-red-700' : 'bg-green-50 text-green-700'"
        class="px-4 py-3 rounded-lg text-sm"
        x-text="message.text"
      ></div>

      <!-- Status Card -->
      <div class="bg-gray-50 rounded-xl p-5 space-y-3">
        <div class="flex justify-between items-center py-2 border-b border-gray-200">
          <span class="text-gray-500 text-sm">Status</span>
          <span 
            :class="{
              'bg-green-100 text-green-700': status.isReady,
              'bg-yellow-100 text-yellow-700': status.isConnected && !status.isReady,
              'bg-blue-100 text-blue-700': status.state === 'CONNECTING',
              'bg-red-100 text-red-700': status.state === 'DISCONNECTED'
            }"
            class="px-3 py-1 rounded-full text-xs font-semibold uppercase flex items-center gap-1.5"
          >
            <span class="w-2 h-2 rounded-full bg-current"></span>
            <span x-text="statusLabel"></span>
          </span>
        </div>
        <div class="flex justify-between items-center py-2 border-b border-gray-200">
          <span class="text-gray-500 text-sm">State</span>
          <span class="font-semibold text-sm" x-text="status.state || '-'"></span>
        </div>
        <div class="flex justify-between items-center py-2">
          <span class="text-gray-500 text-sm">Last Check</span>
          <span class="font-semibold text-sm" x-text="lastCheck || '-'"></span>
        </div>
      </div>

      <!-- Device Info -->
      <div x-show="status.device" x-transition class="bg-green-50 rounded-xl p-5">
        <h3 class="text-green-700 text-sm font-semibold mb-3 flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <rect x="5" y="2" width="14" height="20" rx="2" ry="2" stroke-width="2"/>
            <line x1="12" y1="18" x2="12.01" y2="18" stroke-width="2"/>
          </svg>
          Connected Device
        </h3>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-gray-500">Number</span>
            <span class="text-gray-700 font-medium" x-text="status.device ? '+' + status.device.number : '-'"></span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-500">Name</span>
            <span class="text-gray-700 font-medium" x-text="status.device?.name || '-'"></span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-500">Platform</span>
            <span class="text-gray-700 font-medium" x-text="status.device?.platform || '-'"></span>
          </div>
        </div>
      </div>

      <!-- QR Code Section -->
      <div x-show="qrCode" x-transition class="bg-gray-50 rounded-xl p-5 text-center">
        <img 
          :src="'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent(qrCode)" 
          alt="QR Code"
          class="mx-auto rounded-lg mb-3"
        >
        <p class="text-gray-500 text-sm">Scan this QR code with WhatsApp</p>
        <p class="text-gray-400 text-xs mt-1">Expires in 2 minutes</p>
      </div>

      <!-- Action Buttons -->
      <div class="flex gap-3">
        <button 
          @click="checkStatus()"
          :disabled="loading"
          class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-3 rounded-lg text-sm font-semibold transition-colors disabled:opacity-50 flex items-center justify-center gap-2"
        >
          <svg class="w-4 h-4" :class="{ 'animate-spin': loading }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
          Refresh
        </button>

        <button 
          x-show="!status.isConnected && !status.isReady"
          @click="connect()"
          :disabled="loading"
          class="flex-1 bg-whatsapp hover:bg-whatsapp-dark text-white px-4 py-3 rounded-lg text-sm font-semibold transition-colors disabled:opacity-50"
        >
          <span x-show="!loading">Connect</span>
          <span x-show="loading" class="flex items-center justify-center gap-2">
            <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
            </svg>
            Connecting...
          </span>
        </button>

        <button 
          x-show="status.isConnected || status.isReady"
          @click="disconnect()"
          :disabled="loading"
          class="flex-1 bg-red-50 hover:bg-red-100 text-red-700 px-4 py-3 rounded-lg text-sm font-semibold transition-colors disabled:opacity-50"
        >
          Disconnect
        </button>
      </div>
    </div>

    <!-- Footer -->
    <div class="bg-gray-50 px-6 py-4 text-center text-xs text-gray-400">
      <a href="/docs" target="_blank" class="text-whatsapp hover:underline">API Documentation</a>
      <span class="mx-2">&bull;</span>
      WhatsApp Web API
    </div>
  </div>

  <script>
    function deviceManager() {
      return {
        apiKey: '',
        loading: false,
        message: { text: '', type: '' },
        status: {
          state: 'DISCONNECTED',
          isReady: false,
          isConnected: false,
          device: null
        },
        qrCode: null,
        lastCheck: null,
        refreshInterval: null,

        get statusLabel() {
          if (this.status.isReady) return 'Ready';
          if (this.status.isConnected) return 'Connected';
          if (this.status.state === 'CONNECTING') return 'Connecting';
          return 'Disconnected';
        },

        init() {
          this.apiKey = localStorage.getItem('wa_api_key') || '';
          if (this.apiKey) this.checkStatus();
        },

        saveApiKey() {
          localStorage.setItem('wa_api_key', this.apiKey);
        },

        showMessage(text, type = 'error') {
          this.message = { text, type };
          setTimeout(() => this.message = { text: '', type: '' }, 5000);
        },

        async request(endpoint, method = 'GET') {
          if (!this.apiKey) {
            this.showMessage('Please enter your API key');
            return null;
          }

          try {
            const res = await fetch(endpoint, {
              method,
              headers: {
                'Authorization': `Bearer ${this.apiKey}`,
                'Content-Type': 'application/json'
              }
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.message || 'Request failed');
            return data;
          } catch (e) {
            this.showMessage(e.message);
            return null;
          }
        },

        async checkStatus() {
          this.loading = true;
          const result = await this.request('/device/status');
          this.loading = false;

          if (result?.data) {
            this.status = result.data;
            this.lastCheck = new Date().toLocaleTimeString();
            
            if (this.status.isReady && this.qrCode) {
              this.qrCode = null;
              this.stopAutoRefresh();
              this.showMessage('Device connected successfully!', 'success');
            }
          }
        },

        async connect() {
          this.loading = true;
          const result = await this.request('/device/connect', 'POST');
          this.loading = false;

          if (result?.data) {
            if (result.data.qr) {
              this.qrCode = result.data.qr;
              this.showMessage('Scan QR code with WhatsApp', 'success');
              this.startAutoRefresh();
            } else if (result.data.device) {
              this.status = result.data;
              this.showMessage('Device already connected', 'success');
            }
          }
        },

        async disconnect() {
          if (!confirm('Are you sure you want to disconnect?')) return;

          this.loading = true;
          const result = await this.request('/device/disconnect', 'POST');
          this.loading = false;

          if (result) {
            this.qrCode = null;
            this.stopAutoRefresh();
            this.showMessage('Device disconnected', 'success');
            this.checkStatus();
          }
        },

        startAutoRefresh() {
          this.stopAutoRefresh();
          this.refreshInterval = setInterval(() => this.checkStatus(), 3000);
        },

        stopAutoRefresh() {
          if (this.refreshInterval) {
            clearInterval(this.refreshInterval);
            this.refreshInterval = null;
          }
        }
      }
    }
  </script>
</body>
</html>
